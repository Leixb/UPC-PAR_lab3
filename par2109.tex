% vim: spell spelllang=en:
\input{preamble}

\usepackage{caption}
\usepackage{subcaption}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{lipsum}

\usepackage{siunitx}
\usepackage{hyphenat}

\usepackage{xcolor}

\definecolor{LightGray}{rgb}{0.83, 0.83, 0.83}
\definecolor{bg}{HTML}{282828}

\usepackage{minted}
\setminted{
style=monokai,
%frame=lines,
framesep=2mm,
baselinestretch=1.2,
breaklines,
bgcolor=bg,
fontsize=\footnotesize,
linenos
}

\renewcommand\theadfont{\bfseries}

\title{
    PAR Laboratory Assignment\\
    Lab 3: Embarrassingly parallelism with OpenMP:\\ Mandelbrot set
}

\author{
    par2109:
    Aleix Boné,
    Alex Herrero
}

\date{
    Spring 2019-20
}

\begin{document}

\thispagestyle{empty}
\clearpage
\setcounter{page}{-1}

\begin{titlepage}
{
    \centering
    \null
    \vfill
    {\Huge \bfseries PAR Laboratory Assignment\par}
    \vspace{3em}
    {\Large {\scshape Lab 3:} Embarrassingly parallelism with OpenMP: \\ Mandelbrot set \par}
    \vfill
\begin{center}
\end{center}
    \vspace{3cm}

    \vfill
    {\raggedleft \Large
        Aleix Boné\\
        Alex Herrero\\
        {\bfseries\ttfamily par2109}\\
        \vspace{4em}
        2020-04-16
        \par}
}
\end{titlepage}


\section{Introduction}%
\label{sec:Introduction}

% copy paste form here to ... 
% (solo he cambbiado el tiempo verbal, no se si hace falta cambiarlo más ya que enrealidad lo que queremos decir al principio es lo mismo que dice el enunciado...) (y bueno he borrado un par de parrafos)
In this laboratory assignment we explored the tasking model in OpenMP to express iterative task decompositions. 
We started by exploring the most appropriate ones by using \emph{Tareador}. The program that we used is the computation of the \emph{Mandelbrot set}, a particular set of points, in the complex domain, whose boundary generates a distinctive and easily recognisable two-dimensional fractal shape.

For each point $c$ in a delimited two-dimensional space, the complex quadratic polynomial recurrence $z_{n+1} = z^2_n + c$ is iteratively applied in order to determine if it belongs or not to the Mandelbrot set.  The point is part of the Mandelbrot set if, when starting with $z_0 = 0$ and applying the iteration repeatedly, the absolute value of $z_n$ never exceeds a certain number however large $n$ gets.

We analyzed the potential parallelism for two possible task granularities that can be exploited in this program. Those two are:
\begin{enumerate}[label=\alph*)]
\item \emph{Point}: a task corresponds with the computation of a single point (\texttt{row},\texttt{col}) of the Mandelbrot set.
\item \emph{Row}: a task corresponds with the computation of a whole \texttt{row} of the Mandelbrot set.
\end{enumerate}
% ... here

We executed both, \texttt{mandel-tar}\footnote{\texttt{mandel}: used for timing purposes and to check for the numerical validity of the output (non-graphical version).} and \texttt{mandeld-tar}\footnote{\texttt{mandeld}: generates a binary that visualizes the Mandelbrot set (graphical version).}, programs with the different granularities using the \texttt{./run-tareador.sh} script and we obtained the following results.

\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{plots/dependency_graph_mandel_point.png}
\caption{Task dependence graph of \texttt{mandel-tar.c} with point decomposition.}
\label{graph:mandel_point}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[width=0.6\textwidth]{plots/dependency_graph_mandel_row.pdf}
\caption{Task dependence graph of \texttt{mandel-tar.c} with row decomposition.}
\label{graph:mandel_row}
\end{figure}

As we expected the point decomposition has a much more big granularity than the row one. But we obtained that the two decompositions generate similar task graphs for each executable.

We can observe in figures~\ref{graph:mandel_point} and~\ref{graph:mandel_row} that with the \texttt{mandel} executable all tasks can parallelize at the same level. But in figure~\ref{graph:mandeld_point_and_row} we see that with the \texttt{mandeld} executable we obtain a serialization of all tasks.

\begin{figure}[H]
\centering
\includegraphics[height=8cm]{plots/dependency_graph_mandeld_point.png}
\hspace{5em}
\includegraphics[height=8cm]{plots/dependency_graph_mandeld_row.pdf}
\caption{Task dependence graph of \texttt{mandeld-tar.c} with point and row decompositions.}
\label{graph:mandeld_point_and_row}
\end{figure}

This serialization in the graphical version is caused in the lines XXX of the code due to a data race problem that implies full dependence between all tasks. This section could be protected with the \texttt{#pragma omp critical} clause as shown in the figure~\ref{listing:mandel-omp-critical}.

\begin{listing}
\inputminted[firstline=8,lastline=8]{c}{sources}
\caption{Problematic section in the \texttt{mandel-tar.c} protected with \texttt{#pragma omp critical}.}
\label{listing:mandel-omp-critical}
\end{listing}

% Which are the two most important common characteristics of the task graphs generated for the two task granularities (Point and Row) for the non-graphical version of mandel-tar?  Why the task graphs generated for mandel-tar and mandeld-tar are so different?  Which section of the code do you think is causing the serialization of all tasks in the graphical version?  How will you protect this section of code in the parallel OpenMP code in the next sections?

% Reason which one of the two task granularities would be more appropriate to apply to implement a parallel version of the Mandelbrot code.

\section{Parallelization Strategies}%
\label{sec:Parallelization Strategies}



%aqui explicas las strategias del 4.2, 4.3 y 4.4

%$ OMP_NUM_THREADS=1 ./mandeld-omp -i 10000
%Total execution time: 3.228077s
%$ ./mandeld -i 10000
%Total execution time: 3.061886s
%$ OMP_NUM_THREADS=8 ./mandeld-omp -i 10000
%Total execution time: 1.210712s

\section{Performance evaluation}%
\label{sec:Performance evaluation}

%Aqui comparas

\begin{figure}[H]
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=0.7\linewidth]{plots/v1-crop.pdf}
        \caption{Strong scalability analysis v1}
        \label{fig:ssa_v1} 
    \end{minipage}
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=0.7\linewidth]{plots/v2-crop.pdf}
        \caption{Strong scalability analysis v2}
        \label{fig:ssa_v2} 
    \end{minipage}
\end{figure}

\begin{figure}[H]
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=0.7\linewidth]{plots/v3-crop.pdf}
        \caption{Strong scalability analysis v3}
        \label{fig:ssa_v3} 
    \end{minipage}
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=0.7\linewidth]{plots/v4-crop.pdf}
        \caption{Strong scalability analysis v4}
        \label{fig:ssa_v4} 
    \end{minipage}
\end{figure}


\begin{figure}[H]
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=0.7\linewidth]{plots/v5-crop.pdf}
        \caption{Strong scalability analysis v5}
        \label{fig:ssa_v5} 
    \end{minipage}
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=0.7\linewidth]{plots/v6-crop.pdf}
        \caption{Strong scalability analysis v6}
        \label{fig:ssa_v6} 
    \end{minipage}
\end{figure}

\begin{figure}[H]
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=0.7\linewidth]{plots/v7-crop.pdf}
        \caption{Strong scalability analysis v7}
        \label{fig:ssa_v7} 
    \end{minipage}
    \begin{minipage}{0.5\textwidth}
        \centering
        \includegraphics[width=0.7\linewidth]{plots/v8-crop.pdf}
        \caption{Strong scalability analysis v8}
        \label{fig:ssa_v8} 
    \end{minipage}
\end{figure}


\begin{table}[H]
    \caption{Execution times with different grainsizes}%
    \label{tab:grainsize}
    \begin{center}
    \input{tables/grainsizes}
    \end{center}
\end{table}

\begin{figure}[H]
    \centering
    \includegraphics{plots/grainsize.pdf}
    \caption{Plot of execution time for different grainsizes}
    \label{fig:grain} 
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics{plots/grainsize_log.pdf}
    \caption{Plot of execution time for different grainsizes (log scale)}
    \label{fig:grain_log} 
\end{figure}

\begin{figure}[H]
    \centering
    \caption{Mandel tar code}
    \inputminted[firstline=91,lastline=127]{c}{sources/mandel-tar.c}
    \vspace{-2em}
    \inputminted[firstline=200,lastline=210]{c}{sources/mandel-tar.c}
    \label{fig:grain_log} 
\end{figure}

\section{Conclusions}%
\label{sec:Conclusions}

%I aqui pues relleno bonito del final


\end{document}
